# https://circleci.com/docs/2.0/language-android/ for more details.
version: 2.1


# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build-and-test:
    docker:
      - image: cimg/android:2022.07

    steps:
      # checkout the code from the repository
      - checkout
      - run:
          command: chmod +x ./gradlew
      - run:
          name: set Google Maps API key
          command: echo "MAPS_API_KEY=${MAPS_API_KEY}" > local.properties

      - run:
          name: Download dependencies
          command: ./gradlew androidDependencies

      # The next step will run the unit tests
      - android/run-tests:
          test-command: ./gradlew lint testDebug --continue

      # Then start the emulator and run the Instrumentation tests!
      - android/start-emulator-and-run-tests:
          test-command: ./gradlew connectedDebugAndroidTest
          system-image: system-images;android-24;google_apis;x86

      # And finally run the release build
      - run:
          name: Assemble release build
          command: ./gradlew assembleRelease

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build_and_test:

    jobs:
      - build-and-test
